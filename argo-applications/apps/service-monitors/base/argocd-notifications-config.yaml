apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-cm
    app.kubernetes.io/part-of: argocd
data:
  service.slack: |
    token: $slack-token
    defaultChannel: '#demo-app'  # ðŸ‘ˆ cambia esto por el canal real en tu Slack

  # ðŸŸ¢ Plantillas de mensaje (vinculadas con `send:` en los triggers)
  # template.app-deployed: |
  #   message: |
  #     âœ… App '{{.app.metadata.name}}' was successfully deployed to *{{.app.spec.destination.namespace}}*.
  #     Health: *{{.app.status.health.status}}* | Sync: *{{.app.status.sync.status}}*

  #   slack:
  #     attachments:
  #       - color: "#00FF00"
  #         text: "{{.app.metadata.name}} deployed successfully âœ…"

  template.app-sync-failed: |
    message: |
      Application {{.app.metadata.name}} sync is {{.app.status.sync.status}}.
      Application details: {{.context.argocdUrl}}/applications/{{.app.metadata.name}}.
    slack:
    attachments: |
      [{
        "title": "{{.app.metadata.name}}",
        "title_link": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
        "color": "#18be52",
        "fields": [{
          "title": "Sync Status",
          "value": "{{.app.status.sync.status}}",
          "short": true
        }, {
          "title": "Repository",
          "value": "{{.app.spec.source.repoURL}}",
          "short": true
        }]
      }]

  # template.app-sync-running: |
  #   message: |
  #     ðŸš€ Syncing '{{.app.metadata.name}}'...
  #     Destination: {{.app.spec.destination.server}} (ns: {{.app.spec.destination.namespace}})

  #   slack:
  #     attachments:
  #       - color: "#439FE0"
  #         text: "{{.app.metadata.name}} syncing in progress ðŸš€"

  # ðŸŸ  Triggers que usan esas plantillas
  trigger.on-sync-status-change: |
    - when: app.status.sync.status == 'Synced'
      send: 
        - app-sync-failed
    - when: app.status.sync.status == 'OutOfSync'
      send: 
        - app-sync-failed

  trigger.on-successful-sync: |
    - when: app.status.sync.status == 'Synced' and app.status.health.status == 'Healthy'
      send: 
        - app-sync-failed

  subscriptions: |
    - recipients:
        - slack
      triggers:
        - on-sync-status-change
        - on-successful-sync

---
apiVersion: v1
kind: Secret
metadata:
  name: argocd-notifications-secret
  namespace: argocd
type: Opaque
stringData:
  slack-token: "xoxb-274764143302-9271181208455-jC83xs9SZJLgyQu3bCfTNtXj"
