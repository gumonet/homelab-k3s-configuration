---
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-notifications-cm
    app.kubernetes.io/part-of: argocd
data:
  service.slack: |
    token: $slack-token
    defaultChannel: '#demo-app'

  template.app-sync-running: |
    message: |
      ğŸ”„ Syncing *{{.app.metadata.name}}*...
      â€¢ Namespace: `{{.app.spec.destination.namespace}}`
      â€¢ Server: `{{.app.spec.destination.server}}`
      â€¢ Repo: `{{.app.spec.source.repoURL}}` @ `{{.app.spec.source.targetRevision}}`
      â€¢ Path: `{{.app.spec.source.path}}`
      ğŸ”— {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  template.app-sync-failed: |
    message: |
      âŒ Sync FAILED for *{{.app.metadata.name}}*
      â€¢ Namespace: `{{.app.spec.destination.namespace}}`
      â€¢ Status: *{{.app.status.sync.status}}*
      â€¢ Health: *{{.app.status.health.status}}*
      â€¢ Reason: {{.app.status.operationState.message}}
      ğŸ”— {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  template.app-deployed: |
    message: |
      âœ… *{{.app.metadata.name}}* deployed successfully
      â€¢ Namespace: `{{.app.spec.destination.namespace}}`
      â€¢ Health: *{{.app.status.health.status}}*
      â€¢ Repo: `{{.app.spec.source.repoURL}}` @ `{{.app.spec.source.targetRevision}}`
      ğŸ”— {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  template.app-degraded: |
    message: |
      âš ï¸ *{{.app.metadata.name}}* sync completed, but app is NOT healthy
      â€¢ Namespace: `{{.app.spec.destination.namespace}}`
      â€¢ Sync: *{{.app.status.sync.status}}*
      â€¢ Health: *{{.app.status.health.status}}*
      ğŸ”— {{.context.argocdUrl}}/applications/{{.app.metadata.name}}

  trigger.on-sync-status-change: |
    - when: app.status.operationState.phase == 'Running'
      send:
        - app-sync-running
    - when: app.status.operationState.phase in ['Error', 'Failed']
      send:
        - app-sync-failed
    - when: app.status.sync.status == 'Synced' and app.status.health.status != 'Healthy'
      send:
        - app-degraded

  trigger.on-successful-sync: |
    - when: app.status.sync.status == 'Synced' and app.status.health.status == 'Healthy'
      send:
        - app-deployed

  subscriptions: |
    - recipients:
        - slack:demo-app
      triggers:
        - on-sync-status-change
        - on-successful-sync
---
apiVersion: v1
kind: Secret
metadata:
  name: argocd-notifications-secret
  namespace: argocd
type: Opaque
stringData:
  slack-token: "xoxb-274764143302-9271181208455-jC83xs9SZJLgyQu3bCfTNtXj"
